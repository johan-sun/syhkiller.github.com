---
layout : article
title : 本地公式渲染MathJax
category : 前端
tag : js
---
"MathJax":http://mathjax.org 是javascript写的一个渲染$\Tex$公式的引擎,有了MathJax就能很方便的在博客中写数学公式, 整个工具可以从 "MathJax的官网":http://mathjax.org 下载,也提供了cdn的方式.

h4. 配置MathJax
* 配置行内,行间显示模式
mathjax 使用Json方式配置行内行间模式,所谓行内,行间模式是指除了 @\begin{equation} \end{equation}@ 等模式,mathjax还支持自定义的行内行间模式,也就是说在指定模式内,才会被渲染,默认matjax会使用 @$${}$$@ 渲染行间公式,等价于 @\begin{equation} \end{equation}@ , 可以使用displayMath指定模式,我采用了如下配置,其中 @equationNumbers:{autoNumber:"all"}@ 是为了产生标签,用于引用, 详细可以查看 "这里":http://docs.mathjax.org/en/latest/configuration.html#using-in-line-configuration-options
{% highlight html linenos %}
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
	TeX: { equationNumbers: {autoNumber: "all"} },
	tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
});
</script>
{% endhighlight %}

* 加载MathJax
{% highlight html linenos %}
<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
{% endhighlight %}
我采用了CDN的方式加载MathJax引擎, config可以获取特定的配置,配置选项有
** defualt
** TeX-AMS-MML_HTMLorMML
** TeX-AMS_HTML
** MML_HTMLorMML
** AM_HTMLorMML
** TeX-AMS-MML_SVG
** TeX-MML-AM_HTMLorMML
具体的可以查看 "这里":http://docs.mathjax.org/en/latest/configuration.html#using-a-configuration-file

h4. 回调函数

我的博客使用了 "多说":http://duoshuo.com 作为社会化评论,本以为MathJax可以正确渲染评论里面的公式,但是我发现,多说评论加载是异步的,MathJax渲染也是异步的,也就说,简单的方式下可能多说的评论内容还没加载,MathJax的渲染工作就已经完成,这样评论里面的公式都没法渲染了.

我先是找多说的api,看看能不能注册一个毁掉函数,在多说加载完毕之后再加载MathJax引擎,但是不行,首先多说文档的api都是关于服务器的api,并没有涉及太多的js api,而且万一网络不好,多说加载很慢,岂不是文章就没法渲染了. 那么就要针对多说加载的内容进行再次渲染,或者说排版.

找了许久,终于在example的sample-dynamic-2.html中找到了可能用到的函数 @Typeset@ 和 @Queue@ , 找到 "官方文档":http://docs.mathjax.org/en/latest/api/index.html , "MathJax.Hub.Typeset":http://docs.mathjax.org/en/latest/api/hub.html#Typeset 可以用于排版给定的html对象内的内容,正式我需要的, 还有一个就是 "MathJax.Hub.Queue":http://docs.mathjax.org/en/latest/api/hub.html#methods

@MathJax.Hub.Queue@ 这个函数执行后会返回一个队列,js执行都是异步的,但是有了这个队列就可以模拟出同步的执行,而且MathJax自己的渲染过程也是通过这个进行流程控制,也就是我们的callback一定会在MathJax引擎的渲染工作完成后执行.

好吧,那么就可以自己动手了,首先依然是全局的渲染工作,然后我加了一个定时器,每秒进行一次轮询,查看 @class="ds-powered-by"@ 对象有没有出现(多说加载的评论栏最后一个,我就用这个笨办法判断多说有没有加载完毕), 出现了将整个多说评论栏重新排版, 当然其中也进行了最大轮询的限制,以免在网络不好的情况下浪费游览器资源,代码如下:
{% highlight html linenos %}
<script type="text/javascript">
(function (){
 	var MaxCnt = 30;
	var i = 0;
	var timer = setInterval(function(){
			++i;
			if(i >= MaxCnt){ clearInterval(timer); return;}
			if(MathJax.Hub.Queue){
				if(document.getElementsByClassName('ds-powered-by').length){
					MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById('ds-thread')]);
					clearInterval(timer);
					return;
				}
			}
		},1000);
 })();
</script>
{% endhighlight %}

当然如果不希望某个标签被渲染,只要加上 @class="tex2jax_ignore"@ 即可让其忽略渲染.

*_最后,如果有人知道如何再多说评论加载完毕之后执行指定的回到函数,可以在评论告诉我,万分感谢!_*
